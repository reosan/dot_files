from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.common.alert import Alert
from selenium.webdriver.support import expected_conditions as EC

import numpy as np
import math
import sys
import time
import threading
#import seaborn
#============================================================
ID = 'y101172y101172@gmail.com'
PASSWORD = '8541john'
LOGIN_URL = 'https://demotrade.fx.dmm.com/fxcrichpresen/webrich/direct/login'
PROFILE = '/home/reosan/.mozilla/firefox/i1zq2uyh.selenium'
ARRAY_SIZE = 60
#============================================================
def wait_get_elem_xpath(wait, xpath):
    return wait.until(EC.presence_of_element_located((By.XPATH, xpath)))

def wait_get_elems_xpath(wait, xpath):
    return wait.until(EC.presence_of_all_elements_located((By.XPATH, xpath)))

def float_price(price):
    try:
        f = price[0].text + price[1].text + price[2].text
        return float(f)
    except ValueError:
        return -1.0

def print_price(price, label="", color=""):
    print( '\033[1;' + color + 'm' + label + '\033[0m' + ':' + str(float_price(price)) )

def fetch():
    thread = threading.Timer(3, fetch)
    thread.start()
    print_price(price_bid, label='BID', color='032')

def print_raise():
    print(sys.exc_info()[2])
    print(sys.exc_info()[1])
    print(sys.exc_info()[0])

#========================[START]====================================
try:
    ### 初期設定
    profile = webdriver.FirefoxProfile(PROFILE)
    driver = webdriver.Firefox(firefox_profile=profile)
    wait = WebDriverWait(driver, 1)
    wait10 = WebDriverWait(driver, 10)
    wait20 = WebDriverWait(driver, 20)
    #driver.implicitly_wait(10)

    driver.get(LOGIN_URL)
    driver.find_element_by_id('accountId').send_keys(ID)
    driver.find_element_by_id('password').send_keys(PASSWORD)
    driver.find_element_by_id('LoginWindowBtn').click()

    wait20.until(EC.number_of_windows_to_be(2))
    window = driver.window_handles[-1]
    driver.get('http://www.google.co.jp')
    driver.switch_to_window(window)
    ### タグ取得
    elem_spread = wait_get_elem_xpath(wait20, '//div[@uifield="spread"]')
    price_bid = wait_get_elems_xpath(wait20, '//div[@uifield="bidStreamingButton"]/div/*')    
    price_ask = wait_get_elems_xpath(wait20, '//div[@uifield="askStreamingButton"]/div/*')
    button_order_all =  wait_get_elem_xpath(wait20, '//button[@uifield="orderButtonAll"]')
    button_bid = wait_get_elem_xpath(wait20, '//div[@uifield="bidStreamingButton"]')
    button_ask = wait_get_elem_xpath(wait20, '//div[@uifield="askStreamingButton"]')
    text_order_Lot = wait_get_elem_xpath(wait20, '//input[@uifield="orderQuantity"]')
    button_logout = wait_get_elem_xpath(wait20, '//div[@class="logout label"]')
    
    array = np.zeros(ARRAY_SIZE)
    n = 0

    posi = 0
    ewma_S = 0
    ewma_M = 0
    ewma_L = 0
    ewma_LL = 0
    #============================================================
    array[n] = float_price(price_bid)
    print(array[n])
    print_price(price_bid, label='BID', color='34')
    print_price(price_ask, label='ASK', color='31')
    time.sleep(5)
    button_bid.click()
    time.sleep(5)
    button_order_all.click()

    thread = threading.Thread(target=fetch)
    thread.setDaemon(True)
    thread.start()

    time.sleep(60)


#============================================================
except:
    print_raise()
finally:
    try:
        print(EC.element_to_be_clickable(button_logout))
        button_logout.click()
        button_logout_OK = wait_get_elem_xpath(wait20, '//button[@uifield="okButton"]')
        button_logout_OK.click()
    except:
        print_raise()


time.sleep(1)

try:    
    driver.quit()
except:
    print('\033[31mwarning\033[0m:driver is already quited.')
else:
    print('driver.quit()')
